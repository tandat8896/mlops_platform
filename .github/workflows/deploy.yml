name: CI/CD for Model

on:
  push:
    paths:
      - "data/**"   # data changed
      - "data.dvc" # DVC tracking file changed

  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:

  train_on_server:
    name: Train Model on Remote Server
    runs-on: ubuntu-latest
    outputs:
      promoted: ${{ steps.check_promotion.outputs.promoted }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build training Docker image
      run: |
        docker build -f Dockerfile.train -t mlops-train:latest .

    - name: Save training image
      run: |
        docker save mlops-train:latest | gzip > train-image.tar.gz

    - name: Upload training image to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        port: ${{ secrets.EC2_PORT_SSH }}
        source: "train-image.tar.gz"
        target: "/tmp/"

    - name: SSH and run training in Docker
      uses: appleboy/ssh-action@v1.1.0
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        port: ${{ secrets.EC2_PORT_SSH }}
        envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY
        script: |
          echo "=== Setup Repository ==="
          REPO_DIR="$HOME/Repository/mlops_platform"
          mkdir -p "$REPO_DIR"
          cd "$REPO_DIR" || exit 1
          
          # Clone/pull code
          if [ ! -d ".git" ]; then
            git clone https://github.com/tandat8896/mlops_platform.git .
          else
            git pull origin master || git pull origin main
          fi
          
          echo "=== Load Training Docker Image ==="
          docker load < /tmp/train-image.tar.gz
          rm -f /tmp/train-image.tar.gz
          
          echo "=== Pull DVC Data ==="
          # Install DVC if needed (minimal install)
          if ! command -v dvc &> /dev/null; then
            pip3 install --user dvc[s3] || pip install --user dvc[s3]
          fi
          export PATH="$HOME/.local/bin:$PATH"
          dvc pull || echo "DVC pull failed, continuing..."
          
          echo "=== Run Training in Docker ==="
          export PYTHONUNBUFFERED=1
          docker run --rm \
            -v "$REPO_DIR:/app" \
            -v "$HOME/.aws:/root/.aws:ro" \
            -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
            -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
            -e S3_BUCKET="s3-cicd-1-demo" \
            -e MLFLOW_TRACKING_URI="" \
            mlops-train:latest \
            python train.py --epochs 5 --model yolo11n --batch-size 16 2>&1 | tee /tmp/training.log
          
          TRAIN_EXIT_CODE=${PIPESTATUS[0]}
          if [ $TRAIN_EXIT_CODE -ne 0 ]; then
            echo "=== Training failed ==="
            tail -n 100 /tmp/training.log
            exit $TRAIN_EXIT_CODE
          fi
          
          echo ""
          echo "=== Training Summary ==="
          grep -E "(mAP|Precision|Recall|PROMOTED|promoted)" /tmp/training.log | tail -n 30 || true
          
          echo ""
          echo "=== Check Promotion Status ==="
          if grep -q "PROMOTED TO PRODUCTION" /tmp/training.log; then
            echo " Model PROMOTED - will build and deploy"
            echo "true" > /tmp/model_promoted.txt
          else
            echo "Model NOT promoted - skipping deploy"
            echo "false" > /tmp/model_promoted.txt
          fi
          cat /tmp/model_promoted.txt
          
          echo ""
          echo "=== Push DVC artifacts ==="
          dvc push || echo "DVC push failed, continuing..."

    - name: Check promotion status
      id: check_promotion
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        port: ${{ secrets.EC2_PORT_SSH }}
        script: |
          if [ -f /tmp/model_promoted.txt ]; then
            PROMOTED=$(cat /tmp/model_promoted.txt)
            echo "promoted=$PROMOTED" >> $GITHUB_OUTPUT
            echo "Promotion status: $PROMOTED"
          else
            echo "promoted=false" >> $GITHUB_OUTPUT
            echo "Promotion status: false (file not found)"
          fi

  build_and_push:
    name: Build Docker image & Push GHCR
    needs: train_on_server
    runs-on: ubuntu-latest
    if: needs.train_on_server.outputs.promoted == 'true'
    outputs:
      image_name: ${{ steps.image.outputs.value }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set lowercase image name
      id: image
      run: |
        IMAGE_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        echo "IMAGE_NAME_LOWER=${IMAGE_LOWER}" >> $GITHUB_ENV
        echo "value=${IMAGE_LOWER}" >> $GITHUB_OUTPUT

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate tag metadata
      id: tag
      run: |
        MODEL_VERSION=$(date +%Y%m%d-%H%M%S)
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "model_version=$MODEL_VERSION" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

    - name: Docker Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}
        tags: |
          type=raw,value=latest
          type=raw,value=model-${{ steps.tag.outputs.model_version }}
          type=raw,value=deploy-${{ steps.tag.outputs.timestamp }}
          type=sha,prefix=sha-

    - name: Build & Push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          MODEL_VERSION=${{ steps.tag.outputs.model_version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy_ec2:
    name: Deploy to EC2
    needs: build_and_push
    runs-on: ubuntu-latest

    steps:
    - name: SSH deploy container on EC2
      uses: appleboy/ssh-action@v1.1.0
      env:
        IMAGE_NAME: ${{ needs.build_and_push.outputs.image_name }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTOR: ${{ github.actor }}
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        port: ${{ secrets.EC2_PORT_DEPLOY }}
        envs: IMAGE_NAME,GITHUB_TOKEN,GITHUB_ACTOR
        script: |
          echo "Logging in to GitHub Container Registry"
          echo ${GITHUB_TOKEN} | docker login ghcr.io -u ${GITHUB_ACTOR} --password-stdin
          
          echo "Pulling latest image"
          docker pull ghcr.io/${IMAGE_NAME}:latest
          
          echo "Stopping and removing old container"
          docker stop app-container || true
          docker rm app-container || true
          
          echo "Starting new container"
          docker run -d --name app-container -p 8000:8000 \
            --restart unless-stopped \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e S3_BUCKET=s3-cicd-1-demo \
            ghcr.io/${IMAGE_NAME}:latest
          
          echo "Cleaning up old images"
          docker image prune -f
